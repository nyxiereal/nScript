name: Build and Release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        runs-on: windows-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.25"

            - name: Get dependencies
              run: go mod download golang.org/x/sys

            - name: Build Normal Mode
              run: |
                  go build -o nScript.exe -ldflags="-s -w" main.go
              env:
                  GOOS: windows
                  GOARCH: amd64
                  CGO_ENABLED: 0

            - name: Build Force Mode
              run: |
                  go build -o nScript-force.exe -ldflags="-s -w" force.go
              env:
                  GOOS: windows
                  GOARCH: amd64
                  CGO_ENABLED: 0

            - name: Push binaries to dist branch
              run: |
                  git config --global user.name "GitHub Actions"
                  git config --global user.email "actions@github.com"

                  # Save current built files and installer scripts
                  New-Item -ItemType Directory -Path ..\dist-temp -Force | Out-Null
                  Copy-Item nScript.exe, nScript-force.exe, get.ps1, get-force.ps1, vercel.json -Destination ..\dist-temp\

                  # Create or checkout dist branch
                  git fetch origin dist:dist 2>$null
                  if ($LASTEXITCODE -eq 0) {
                      git checkout dist
                  } else {
                      git checkout --orphan dist
                  }

                  # Clear everything except .git
                  Get-ChildItem -Force -Exclude .git | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue

                  # Copy the saved files
                  Copy-Item ..\dist-temp\* -Destination . -Force

                  # Add and commit
                  git add -f nScript.exe nScript-force.exe get.ps1 get-force.ps1 vercel.json
                  git commit -m "Build artifacts for ${{ github.ref_name }}"
                  if ($LASTEXITCODE -eq 0) {
                      git push -f origin dist
                  } else {
                      Write-Host "No changes to commit"
                  }