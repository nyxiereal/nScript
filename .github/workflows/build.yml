name: Build and Release

on:
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.25"

            - name: Download deps
              run: go mod download golang.org/x/sys

            - name: Build Windows binaries
              run: |
                  export BINARY_NAME=nScript.exe
                  env GOOS=windows GOARCH=amd64 CGO_ENABLED=0 \
                    go build -trimpath -ldflags="-s -w" -o $BINARY_NAME main.go

            - name: Install UPX
              run: |
                  sudo apt-get update
                  sudo apt-get install -y upx || echo "UPX not available"

            - name: Compress binary with UPX
              run: |
                  if [ -f nScript.exe ]; then upx --best --lzma nScript.exe; fi

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: nScript-windows-amd64
                  path: nScript.exe

            - name: Push binaries to dist branch
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"

                  # Prepare a temporary folder
                  mkdir -p ../dist-temp
                  cp nScript.exe get.ps1 get-force.ps1 vercel.json ../dist-temp/ || true

                  # Create a new orphan dist branch or checkout if it exists on origin
                  git fetch origin dist:dist || true
                  if git show-ref --verify --quiet refs/heads/dist; then
                    git checkout dist
                    git rm -rf . || true
                  else
                    git checkout --orphan dist
                    git rm -rf . || true
                  fi

                  cp -r ../dist-temp/* .
                  git add -f nScript.exe get.ps1 get-force.ps1 vercel.json || true
                  git commit -m "Build artifacts for $GITHUB_REF_NAME" || echo "No changes to commit"
                  git push -f origin dist || echo "Push failed"
